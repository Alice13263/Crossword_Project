<!DOCTYPE html>
<html lang="en-GB">
    <head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	    <title>Create Account - Crossword Generator & Solver</title>
        <link rel = "stylesheet" href = "CSS_stylesheet.css">
        <script src="https://unpkg.com/@supabase/supabase-js"></script>
    </head>
    <body>
       <div class = "wrapper">
            <a class = "top"></a>
            <header class = "login_header">
                <div class = "accessibility_menu_button_div">
                    <!-- Add the function to the accesibility menu button when the page has been created -->
                    <button type = "button" class = "accessibility_menu_button elements_overlay"></button>
                </div>
            </header>
            <main>
                <div class = "page_title_container">
                    <h1 class = "text page_title">Create Account</h1>
                    <h3 class = "text page_subtitle">Crossword Clue Solver & Generator</h3>
                </div>
                <div class = "enter_info_container">
                    <div class = "enter_div">
                        <div class = "info_enter_area">
                            <p class = "text" style = "font-weight: bold;">Username:</p>
                            <input type = "text" class = "text input_field" id = "username_input" placeholder = "Minimum 8 Characters" required = "required">
                        </div>
                        <!-- Text will be added when the user inputs invalid info -->
                        <p id = "error_username" class = "text" style = "color: rgb(240,36,29);"></p>
                    </div>
                    <div class = "enter_div">
                        <div class = "info_enter_area">
                            <p class = "text" style = "font-weight: bold;">Password:</p>
                            <input type = "text" class = "text input_field" id = "password_input" placeholder = "Minimum 8 Characters" required = "required">
                        </div>
                        <!-- Text will be added when the user inputs invalid info -->
                        <p id = "error_password" class = "text" style = "color: rgb(240,36,29);"></p>
                    </div>
                    <div class = "enter_div">
                        <div class = "info_enter_area">
                            <p class = "text" style = "font-weight: bold;">Repeat Password:</p>
                            <input type = "text" class = "text input_field" id = "repeat_password_input" placeholder = "Minimum 8 Characters" required = "required">
                        </div>
                        <!-- Text will be added when the user inputs invalid info -->
                        <p id = "error_password_repeat" class = "text" style = "color: rgb(240,36,29);"></p>
                    </div>
                </div>
                <div class = "submit_button_div">
                    <button type = "button" class = "create_account_button text elements_overlay" onclick = "validCreation()">CREATE</button>
                </div>
                <div class = "login_link_div">
                    <a class = "text" href = "http://127.0.0.1:5500/Login%20Page.html">Already have an account? Login here</a>
                </div>
            </main>
       </div>
       <script>
            const supabase_url = "https://zduutknmvdwdubjcsmao.supabase.co";
            const superbase_anon_key = "sb_publishable_vMIDnCXJvUb-N7s7V69NoA_MUS5BP71";
            const supabase_client = supabase.createClient(supabase_url, superbase_anon_key);
            const valid_username = /^\w+$/;
            const valid_password = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%?=*&Â£]).*$/;
            async function createUser(){
                const username_valid = document.getElementById("username_input").value.trim();
                const password_valid = document.getElementById("password_input").value.trim();
                const {error} = await supabase_client
                    .from("users")
                    .insert([{username: username_valid, password: password_valid}]);
                if (error) {
                    if (error.message.includes("duplicate key value")){
                        document.getElementById("error_username").innerText = "Username already taken";
                    }
                    else{
                        document.getElementById("error_username").innerText = "Error: " + error.message;
                    }
                }
                else{
                    localStorage.setItem("username", username_valid);
                    window.location.href = "Main Menu Page.html";
                }
            };
            function validateUsername(username){
                var entered_username = document.getElementById(username).value;
                if ((entered_username.length < 8) || (valid_username.test(entered_username) == false)){
                    const username_error = document.getElementById("error_username");
                    username_error.innerText = "Must be at least 8 characters, only letters, numbers and underscores";
                }
                else{
                    const username_no_error = document.getElementById("error_username");
                    username_no_error.innerText = "";
                    return true
                }
            };
            function validatePassword(password){
                var entered_password = document.getElementById(password).value;
                if ((entered_password.length < 8) || (valid_password.test(entered_password) == false)){
                    const password_error = document.getElementById("error_password");
                    password_error.innerText = "Must be at least 8 characters, at least 1 upper case, lower case, integer, and special character"
                }
                else{
                    const password_no_error = document.getElementById("error_password");
                    password_no_error.innerText = "";
                    return true
                }
            };
            function validateMatchingPassword(password, repeat_password){
                const password1 = document.getElementById(password).value;
                const password2 = document.getElementById(repeat_password).value;
                if (password1 != password2){
                    const repeat_password_error = document.getElementById("error_password_repeat");
                    repeat_password_error.innerText = "Passwords must match"
                }
                else{
                    const repeat_password_no_error = document.getElementById("error_password_repeat");
                    repeat_password_no_error.innerText = "";
                    return true 
                }
            };
            function validCreation(){
                if ((validateUsername("username_input") == true) && (validatePassword("password_input") == true) && (validateMatchingPassword("password_input","repeat_password_input") == true)){
                    createUser()
                }
            }
       </script>
    </body>
</html>